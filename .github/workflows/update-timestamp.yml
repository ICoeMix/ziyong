name: Update File Timestamps

on:
  push:
    branches: [ main ]

jobs:
  update-timestamps:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ä¿è¯ git log å¯ç”¨

      - name: Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Update timestamps for modified files (macOS compatible)
        run: |
          set -euo pipefail

          # èŽ·å–ä¸Šä¸€æ¬¡æäº¤ï¼Œå¦‚æžœæ²¡æœ‰å°±ç”¨ç©º
          PREV_COMMIT=$(git rev-parse HEAD~1 2>/dev/null || echo "")

          if [ -z "$PREV_COMMIT" ]; then
            MOD_FILES=$(git ls-files)  # é¦–æ¬¡ pushï¼Œå…¨é‡å¤„ç†
          else
            MOD_FILES=$(git diff --name-only "$PREV_COMMIT" HEAD || true)
          fi

          if [ -z "$MOD_FILES" ]; then
            echo "No modified files, skipping."
            exit 0
          fi

          echo "$MOD_FILES" | while IFS= read -r FILE; do
            [ ! -f "$FILE" ] && continue
            grep -q 'âŸ¦TIMESTAMPâŸ§' "$FILE" || continue

            # èŽ·å–æ–‡ä»¶æœ€åŽä¿®æ”¹æ—¶é—´
            LAST_MOD=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M' -- "$FILE" || true)
            [ -z "$LAST_MOD" ] && LAST_MOD=$(date +"%Y-%m-%d %H:%M")
            TIMESTAMP="âŸ¦$LAST_MODâŸ§"

            # macOS ç‰ˆæœ¬ sed æ›¿æ¢å ä½ç¬¦
            sed -i '' "s/âŸ¦TIMESTAMPâŸ§/$TIMESTAMP/g" "$FILE"

            git add "$FILE"
            echo "Updated $FILE -> $TIMESTAMP"
          done

      - name: Commit and push
        run: |
          if git diff --cached --quiet; then
            echo "No timestamp updates needed."
          else
            git commit -m "ðŸ•’ Auto update timestamps for modified files"
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            git push origin "$BRANCH" || echo "Push failed, maybe branch protected"
