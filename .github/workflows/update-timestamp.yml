name: Update File Timestamps

on:
  push:
    branches: [ main ]  # æˆ–è€… master

jobs:
  update-timestamps:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ æ‹‰å–å®Œæ•´ä»“åº“å†å²ï¼Œä¿è¯ git log å¯ç”¨
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
      - name: Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # 3ï¸âƒ£ æ›´æ–°å ä½ç¬¦ï¼Œåªé’ˆå¯¹ä¿®æ”¹è¿‡çš„æ–‡ä»¶
      - name: Update timestamps for modified files
        run: |
          # è·å–è¿™æ¬¡ commit ä¿®æ”¹çš„æ–‡ä»¶
          git diff --name-only HEAD~1 HEAD | while IFS= read -r FILE; do
            [ ! -f "$FILE" ] && continue
            grep -q 'âŸ¦TIMESTAMPâŸ§' "$FILE" || continue

            # è·å–æœ€åä¿®æ”¹æ—¶é—´ï¼Œå¦‚æœä¸ºç©ºç”¨å½“å‰æ—¶é—´
            LAST_MOD=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M' -- "$FILE")
            [ -z "$LAST_MOD" ] && LAST_MOD=$(date +"%Y-%m-%d %H:%M")

            TIMESTAMP="âŸ¦$LAST_MODâŸ§"

            # æ›¿æ¢å ä½ç¬¦
            sed -i "s/âŸ¦TIMESTAMPâŸ§/$TIMESTAMP/g" "$FILE"

            # æ·»åŠ åˆ°æš‚å­˜åŒº
            git add "$FILE"
            echo "Updated $FILE -> $TIMESTAMP"
          done

      # 4ï¸âƒ£ æäº¤ä¿®æ”¹
      - name: Commit and push
        run: |
          if git diff --cached --quiet; then
            echo "No timestamp updates needed."
          else
            git commit -m "ğŸ•’ Auto update timestamps for modified files"
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            git push origin "$BRANCH" || echo "Push failed, maybe branch protected"
