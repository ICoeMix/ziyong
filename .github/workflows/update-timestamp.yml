name: Update File Timestamps

on:
  push:
    branches: [ main ]  # æˆ– master

jobs:
  update-timestamps:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ æŸ¥æ‰¾æ‰€æœ‰å«æœ‰ âŸ¦TIMESTAMPâŸ§ çš„æ–‡ä»¶
      - name: Find files with timestamp placeholder
        id: find_files
        run: |
          FILES=$(grep -rl 'âŸ¦TIMESTAMPâŸ§' .)
          echo "files=$FILES" >> $GITHUB_OUTPUT

      # 3ï¸âƒ£ æ›´æ–°æ—¶é—´æˆ³
      - name: Update timestamps
        run: |
          for FILE in ${{ steps.find_files.outputs.files }}; do
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹è¿‡
            if git diff --quiet "$FILE"; then
              echo "$FILE not modified, skip"
              continue
            fi

            # è·å–æ–‡ä»¶æœ€åä¿®æ”¹çš„æ—¥æœŸ
            LAST_MOD=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M' -- "$FILE")
            TIMESTAMP="âŸ¦$LAST_MODâŸ§"

            # æ›¿æ¢å ä½ç¬¦
            sed -i "s/âŸ¦TIMESTAMPâŸ§/$TIMESTAMP/g" "$FILE"

            # æ·»åŠ åˆ°æš‚å­˜åŒº
            git add "$FILE"
            echo "Updated timestamp for $FILE -> $TIMESTAMP"
          done

          # å¦‚æœæœ‰ä¿®æ”¹æ‰æäº¤
          git diff --cached --quiet || {
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git commit -m "ğŸ•’ Auto update file timestamps"
            git push
          }
